<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastrar Produto - StoreManager</title>
    <link rel="stylesheet" href="/storemanager-frontend-main/Tela home/css/cadastroProduto.css">
    <link rel="stylesheet" href="/css/estoque.css">

        <style>
         .upload-area-small { border:2px dashed #20b2aa; padding:18px; text-align:center; border-radius:6px; background:#f6fffc; cursor:pointer; }
        .upload-area-small.dragover { background:#e8fff6; border-color:#0aa686; }
        .small-preview { margin-top:12px; }
        .small-preview img { width:140px; height:90px; object-fit:contain; border:1px solid #eee; border-radius:6px; background:#fff; }

        .upload-area-small.has-image { border-style: solid; background: #f0f8ff; }
        #cardUploadText { transition: all 0.3s ease; }
        .upload-area-small.has-image #cardUploadText { font-weight: bold; color: #0a3d62; }
    </style>

    <style>
        .card-fields,
        .other-fields {
            display: none;
        }

        .container {
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }

        .form-row {
            display: flex;
            gap: 20px;
        }

        .form-row>.form-group {
            flex: 1;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        input[type="text"],
        input[type="number"],
        select,
        textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }

        .btn-primary {
            background-color: #007bff;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .btn-secondary {
            background-color: #6c757d;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            text-decoration: none;
            display: inline-block;
        }

        #alerts {
            margin-top: 20px;
        }

        .alert {
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 4px;
        }

        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border-color: #c3e6cb;
        }

        .alert-error {
            background-color: #f8d7da;
            color: #721c24;
            border-color: #f5c6cb;
        }

        .card-fields,
        .other-fields {
            border: 1px solid #007bff;
            padding: 15px;
            margin-top: 20px;
            border-radius: 5px;
        }

        .card-fields h3,
        .other-fields h3 {
            margin-top: 0;
            color: #007bff;
        }

        .required {
            color: red;
        }

        .form-actions {
            margin-top: 20px;
            display: flex;
            gap: 10px;
        }
    </style>
</head>

<body>
    <header class="main-header">
        <div class="header-container">
            <div class="logo-container">
                <div class="logo-icon">RTR</div>
                <div class="logo-text">StoreManager</div>
            </div>
            <nav class="main-navigation">
                <button class="nav-button" onclick="location.href='gestao_interna.html'">Gestão Interna</button>
                <button class="nav-button" onclick="location.href='externo.html'">Mercado Externo</button>
                <button class="nav-button" onclick="location.href='analytics.html'">Analytics</button>
                <button class="nav-button active" onclick="location.href='estoque.html'">Estoque</button>
            </nav>
        </div>
    </header>

    <div class="container">
        <div class="header">
            <h1>Cadastrar Produto</h1>
            <p>Adicione um novo produto ao sistema de estoque</p>
        </div>

        <div class="form-container">
            <form id="product-form">
                <div class="form-group">
                    <label for="product-name">Nome do Produto <span class="required">*</span></label>
                    <input type="text" id="product-name" name="name" required
                        placeholder="Ex: Booster Box Paldean Fates">
                </div>

                <div class="form-group">
                    <label for="product-description">Descrição</label>
                    <textarea id="product-description" name="description"
                        placeholder="Ex: Caixa lacrada com 36 boosters"></textarea>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="product-type">Tipo <span class="required">*</span></label>
                        <select id="product-type" name="type" required>
                            <option value="">Selecione um tipo</option>
                            <option value="BOOSTER_BOX">Booster Box</option>
                            <option value="ACCESSORY">Acessório</option>
                            <option value="CARD">Carta</option>
                            <option value="OTHER">Outro</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="product-condition">Condição <span class="required">*</span></label>
                        <select id="product-condition" name="condition" required>
                            <option value="MINT">Mint</option>
                            <option value="SEALED">Sealed</option>
                            <option value="LIGHTLY_PLAYED">Lightly Played</option>
                            <option value="MODERATELY_PLAYED">Moderately Played</option>
                            <option value="HEAVILY_PLAYED">Heavily Played</option>
                            <option value="DAMAGED">Damaged</option>
                            <option value="OPENED">Opened</option>
                            <option value="USED">Used</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="product-price">Preço de Venda Sugerido (R$) <span class="required">*</span></label>
                        <input type="number" id="product-price" name="price" step="0.01" min="0" required
                            placeholder="1200.00">
                    </div>

                    <div class="form-group">
                        <label for="target-store-select">Loja de Destino <span class="required">*</span></label>
                        <select id="target-store-select" name="store_id" required>
                            <option value="2ab08857-c06c-4fa2-8d6b-0e6822d1d528">Loja 01 (Meruru TCG Store)</option>
                            <option value="d3cf0acf-d19d-46b2-9ffa-812740ed082c">Loja 02 (Meruru TCG Store Curitiba)
                            </option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group" id="existing-product-id-group" style="display: none;">
                        <label for="existing-product-id">ID do Produto Existente (Para atualização de estoque) <span
                                class="required">*</span></label>
                        <input type="text" id="existing-product-id" name="existing_product_id"
                            placeholder="UUID do produto existente">
                    </div>
                </div>

                <!-- CAMPOS EXCLUSIVOS PARA OUTROS PRODUTOS (BOOSTER_BOX, ACCESSORY, OTHER) -->
                <div id="other-fields" class="other-fields">
                    <h3>Informações Adicionais do Produto</h3>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="other-nationality">Nacionalidade</label>
                            <input type="text" id="other-nationality" name="other_nationality"
                                placeholder="Ex: JAPANESE">
                        </div>

                        <div class="form-group">
                            <label for="package-contents">Conteúdo do Pacote</label>
                            <input type="text" id="package-contents" name="package_contents"
                                placeholder="Ex: 60 unidades">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="extra-info">Informação Extra</label>
                        <textarea id="extra-info" name="extra_info"
                            placeholder="Ex: Edição limitada de 2025"></textarea>
                    </div>
                </div>

                <!-- CAMPOS EXCLUSIVOS PARA CARTA -->
                <div id="card-fields" class="card-fields">
                    <h3>Informações da Carta</h3>

                    <div class="form-group">


<button id="openCamBtn">Abrir Câmera</button>

<div id="cameraBox" style="display:none; position:relative; width:400px;">
    
    <!-- O VÍDEO (ID CORRETO) -->
    <video id="video" width="400" autoplay playsinline style="border:1px solid #ccc;"></video>

    <!-- OVERLAY DO RECORTE  -->


    <br>

    <button id="openCamBtn">Capturar</button>

    <!-- CANVAS PARA SNAPSHOT REAL (OCULTO) -->
    <canvas id="snapshot" width="400" height="300" style="display:none;"></canvas>

</div>

                    <label>Upload da Imagem da Carta</label>
                    <div id="cardUploadArea" class="upload-area-small">
                        <div id="cardUploadText">Clique ou arraste a imagem da carta aqui</div>
                        <input id="cardFileInput" type="file" accept="image/*" style="display:none;">
                    </div>

                    <div class="small-preview" id="cardPreviewBlock" style="display:none;">
                        <!-- apenas a imagem original enviada pelo usuário -->
                        <img id="cardOriginalPreview" alt="Pré-visualização da Carta" src="" />
                    </div>

                    <div style="margin-top:10px;">
                        <button type="button" id="cardProcessBtn" class="btn-primary" disabled>Processar Carta</button>
                        <span id="cardLoading" class="note hidden"></span>
                    </div>
                </div>


                    <div class="form-group">
                        <label for="card-title">Título da Carta <span class="required">*</span></label>
                        <input type="text" id="card-title" name="title" placeholder="Ex: Pikachu EX">
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="card-season">Temporada / Edição</label>
                            <input type="text" id="card-season" name="season" placeholder="Ex: Scarlet & Violet">
                        </div>

                        <div class="form-group">
                            <label for="card-type">Tipo Pokémon</label>
                            <input type="text" id="card-type" name="pokemon_type" placeholder="Ex: Elétrico">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="card-collection">Coleção</label>
                            <input type="text" id="card-collection" name="collection_id"
                                placeholder="Ex: PALDEAN-FA-001">
                        </div>

                        <div class="form-group">
                            <label for="card-code">Código da Carta</label>
                            <input type="text" id="card-code" name="code" placeholder="Ex: 045/198">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="card-rarity">Raridade</label>
                            <input type="text" id="card-rarity" name="rarity" placeholder="Ex: Ultra Rara">
                        </div>

                        <div class="form-group">
                            <label for="card-nationality">Nacionalidade</label>
                            <input type="text" id="card-nationality" name="nationality" placeholder="Ex: Japonês">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="card-category">Categoria da Carta <span class="required">*</span></label>
                            <select id="card-category" name="category" required onchange="verificarCategoria()">
                                <option value="">Selecione a Categoria</option>
                                <option value="pokemon">Pokémon</option>
                                <option value="treinador">Treinador</option>
                                <option value="energia">Energia</option>
                            </select>
                        </div>
                    </div>

                    <div id="btn-step-container" style="text-align: center; margin: 15px 0; display: none;">
                        <button type="button" onclick="mostrarCamposIA()"
                            style="background-color: #6c757d; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">
                            Pedir ajuda com Precificação para Modelo
                        </button>
                    </div>

                    <div id="ai-setup-area"
                        style="display: none; background-color: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #3c5aa6; margin-bottom: 20px;">
                        <h4 style="margin-top: 0; color: #3c5aa6;">Parâmetros de Precificação (IA)</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="card-subtype">Sub-Tipo <span class="required">*</span></label>
                                <select id="card-subtype" name="subtype" style="width: 100%; padding: 8px;">
                                    <option value="Basic">Básico (Comum)</option>
                                    <option value="ex">Pokémon ex</option>
                                    <option value="Stage 1">Estágio 1</option>
                                    <option value="Stage 2">Estágio 2</option>
                                    <option value="Trainer">Treinador</option>
                                    <option value="Item">Item</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="card-rarity-ia">Raridade Oficial <span class="required">*</span></label>
                                <select id="card-rarity-ia" name="rarity" style="width: 100%; padding: 8px;">
                                    <option value="Common">Common (Comum)</option>
                                    <option value="Uncommon">Uncommon (Incomum)</option>
                                    <option value="Rare">Rare (Rara)</option>
                                    <option value="Double Rare">Double Rare</option>
                                    <option value="Ultra Rare">Ultra Rare</option>
                                    <option value="Illustration Rare">Illustration Rare</option>
                                    <option value="Special Illustration Rare">Special Illustration Rare</option>
                                    <option value="Hyper Rare">Hyper Rare</option>
                                    <option value="ACE SPEC Rare">ACE SPEC Rare</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-actions" style="text-align: center; margin-top: 15px;">
                            <button type="button" onclick="calcularPreco()"
                                style="background-color: #0a3d62; color: #ffffff; font-weight: bold; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px;">
                                Prever Preço
                            </button>
                        </div>
                    </div>
                    <div id="resultado-ia" style="display: none; margin-top: 20px;"></div>
                </div>
        </div>

        <div class="form-actions">
            <button type="submit" class="btn btn-primary">Cadastrar Produto</button>
            <a href="estoque.html" class="btn btn-secondary">Voltar ao Sistema</a>
        </div>

        </form>
    </div>

    <div id="alerts"></div>
    </div>

    <script src="/js/cadastro_produto.js"></script>
</body>

</html>


<script>
/* ===== UI wiring ===== */
const productType = document.getElementById('product-type');
const otherFields = document.getElementById('other-fields');
const cardFields = document.getElementById('card-fields');

productType.addEventListener('change', () => {
    const v = productType.value;
    otherFields.style.display = (v === 'BOOSTER_BOX' || v === 'ACCESSORY' || v==='OTHER') ? 'block' : 'none';
    cardFields.style.display = (v === 'CARD') ? 'block' : 'none';
});

/* ===== Card upload/process UI ===== */
const cardFileInput = document.getElementById('cardFileInput');
const cardProcessBtn = document.getElementById('cardProcessBtn');
const cardPreviewBlock = document.getElementById('cardPreviewBlock');
const cardOriginalPreview = document.getElementById('cardOriginalPreview');
const cardLoading = document.getElementById('cardLoading');
const cardUploadText = document.getElementById('cardUploadText');
const camBox = document.getElementById("cameraBox");
const canvas = document.getElementById("canvas");
const openCamBtn = document.getElementById("openCamBtn");

/* ===== CONFIG ===== */
const CROP_FRAC = { xs: 0.09, ys: 0.93, xe: 0.22, ye: 0.97 }; // use seus valores

/* ===== ELEMENTOS ===== */
const video = document.getElementById('video'); // ID correto do vídeo
const cardUploadArea = document.getElementById('cardUploadArea'); // se ainda usar
const frameBox = document.getElementById('frame-box'); // o div overlay que já colocou
const snapshotCanvas = document.getElementById('snapshot');
let streamRef = null;

/* ===== Inicia câmera ===== */
async function startCamera() {
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" }});
        streamRef = stream;
        video.srcObject = stream;
        // quando metadata carregar, posiciona o frame
        video.addEventListener('loadedmetadata', () => {
            positionFrameOverlay();
        });
    } catch (err) {
        console.error("Erro ao acessar câmera:", err);
        alert("Não foi possível acessar a câmera: " + err.message);
    }
}
startCamera();

/* ===== Posiciona o overlay de corte exatamente nas frações definidas ===== */
function positionFrameOverlay() {
    // vídeo pode ter CSS de largura/altura diferentes; usamos a dimensão exibida
    const vw = video.clientWidth;
    const vh = video.clientHeight;

    // calcula em pixels (relativo ao elemento video exibido)
    const leftPx = Math.round(CROP_FRAC.xs * vw);
    const topPx = Math.round(CROP_FRAC.ys * vh);
    const widthPx = Math.round((CROP_FRAC.xe - CROP_FRAC.xs) * vw);
    const heightPx = Math.round((CROP_FRAC.ye - CROP_FRAC.ys) * vh);

    // aplica ao frameBox (overlay posicionado em relação ao vídeo)
    frameBox.style.left = leftPx + 'px';
    frameBox.style.top = topPx + 'px';
    frameBox.style.width = widthPx + 'px';
    frameBox.style.height = heightPx + 'px';
    frameBox.style.position = 'absolute';
    frameBox.style.pointerEvents = 'none';
}

/* ===== Captura e envia ===== */
async function captureAndSend() {
    if (!video || !streamRef) {
        alert("Câmera não iniciada");
        return;
    }

    // usa resolução real do vídeo para enviar imagem com dimensões corretas
    const realW = video.videoWidth;
    const realH = video.videoHeight;

    // ajusta canvas para resolução real
    snapshotCanvas.width = realW;
    snapshotCanvas.height = realH;
    const ctx = snapshotCanvas.getContext('2d');

    // desenha frame inteiro (resolução real)
    ctx.drawImage(video, 0, 0, realW, realH);

    // calcula crop em pixels na resolução real (mesma fração do servidor)
    const cx = Math.round(CROP_FRAC.xs * realW);
    const cy = Math.round(CROP_FRAC.ys * realH);
    const cw = Math.round((CROP_FRAC.xe - CROP_FRAC.xs) * realW);
    const ch = Math.round((CROP_FRAC.ye - CROP_FRAC.ys) * realH);

    // cria canvas para o crop para mostrar preview e enviar se quiser
    const cropCanvas = document.createElement('canvas');
    cropCanvas.width = cw;
    cropCanvas.height = ch;
    const cctx = cropCanvas.getContext('2d');
    // desenha só a área do crop no cropCanvas
    cctx.drawImage(snapshotCanvas, cx, cy, cw, ch, 0, 0, cw, ch);

    // mostra preview do crop (insere na div de preview ou atualiza img)
    const previewBlock = document.getElementById('cardPreviewBlock');
    previewBlock.innerHTML = ''; // limpa
    const img = document.createElement('img');
    img.src = cropCanvas.toDataURL('image/png');
    img.style.width = '140px';
    img.style.height = '90px';
    img.style.objectFit = 'contain';
    previewBlock.style.display = 'flex';
    previewBlock.appendChild(img);

    // Enviar para backend: enviamos a imagem inteira + coords (backend pode cortar de novo ou usar o crop já feito)
    // Aqui eu envio o FRAME COMPLETO (melhor para backend aplicar o mesmo crop) + coords
    const fullDataURL = snapshotCanvas.toDataURL('image/png');

    try {
        const res = await fetch('/process_camera', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                image: fullDataURL,
                crop: CROP_FRAC  // opcional: informa as frações ao backend
            })
        });
        const data = await res.json();
        console.log('Resposta OCR/camada DB:', data);

        // preenche campos conforme resposta (exemplo)
        if (data.ocr_results) {
            document.getElementById('card-code').value = data.ocr_results.db_code || '';
        }
        if (data.database_results && data.database_results.database_match) {
            const card = data.database_results.database_match;
            document.getElementById('card-title').value = card.title || '';
            document.getElementById('card-collection').value = card.collection_abbreviation || card.collection_name || '';
            document.getElementById('card-rarity').value = card.rarity || '';
        }

        if (data.visualization && data.visualization.cropped_image_server_path) {
            // opcional: mostrar imagem gerada no servidor (se o backend expuser)
            const serverCropImg = document.createElement('img');
            serverCropImg.src = data.visualization.cropped_image_server_path;
            serverCropImg.style.width = '140px';
            serverCropImg.style.height = '90px';
            serverCropImg.style.objectFit = 'contain';
            previewBlock.appendChild(serverCropImg);
        }

        // feedback
        const alerts = document.getElementById('alerts');
        alerts.innerHTML = `<div class="alert alert-success">Processamento realizado.</div>`;
    } catch (err) {
        console.error('Erro no envio:', err);
        const alerts = document.getElementById('alerts');
        alerts.innerHTML = `<div class="alert alert-error">Erro no processamento: ${err.message}</div>`;
    }
}

/* conecta botão */
document.getElementById('cardProcessBtn').addEventListener('click', captureAndSend);

/* reposiciona overlay no resize da janela */
window.addEventListener('resize', () => {
    if (video && video.clientWidth) positionFrameOverlay();
});



openCamBtn.onclick = async () => {
    camBox.style.display = "block";

    const stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: "environment" } // usa webcam traseira quando possível
    });

    video.srcObject = stream;
};


let cardFile = null;

cardUploadArea.addEventListener('click', () => cardFileInput.click());
cardUploadArea.addEventListener('dragover', (e) => { 
    e.preventDefault(); 
    cardUploadArea.classList.add('dragover'); 
});
cardUploadArea.addEventListener('dragleave', () => cardUploadArea.classList.remove('dragover'));
cardUploadArea.addEventListener('drop', (e) => {
    e.preventDefault(); 
    cardUploadArea.classList.remove('dragover');
    if (e.dataTransfer.files && e.dataTransfer.files.length) handleCardFile(e.dataTransfer.files[0]);
});
cardFileInput.addEventListener('change', (e) => { 
    if (e.target.files && e.target.files[0]) handleCardFile(e.target.files[0]); 
});

function handleCardFile(f) {
    if (!f.type.startsWith('image/')) { 
        showAlert('Selecione apenas imagens (JPG, PNG, etc.)', 'error'); 
        return; 
    }
    
    cardFile = f;
    cardProcessBtn.disabled = false;
    
    // preview original image locally
    const url = URL.createObjectURL(f);
    cardOriginalPreview.src = url;
    cardPreviewBlock.style.display = 'block';
    
    // Atualizar a área de upload para mostrar que tem uma imagem
    cardUploadArea.classList.add('has-image');
    cardUploadText.textContent = 'Imagem carregada! Clique para trocar';
    
    showAlert('Imagem carregada com sucesso! Clique em "Processar Carta" para extrair os dados.', 'success');
}

/* Helper: format letters+number into SVP-025 style (best-effort) */
function formatDbCode(lettersRaw, numberRaw) {
    if (!lettersRaw && !numberRaw) return null;
    let letters = (lettersRaw||'').toUpperCase().replace(/[^A-Z]/g,'');
    // prefer first token like SVP or first 2-4 letters
    const m = letters.match(/^[A-Z]{2,6}/);
    letters = m ? m[0] : letters.substr(0,3);
    let num = (numberRaw||'').toString().replace(/[^0-9]/g,'');
    if (num) {
        // pad to 3
        try { num = String(parseInt(num,10)).padStart(3,'0'); } catch(e){ num = num.padStart(3,'0'); }
        return `${letters}-${num}`;
    } else {
        return letters;
    }
}

/* Process image: send to /upload */
async function processCardImage() {
    if (!cardFile) { 
        showAlert('Selecione uma imagem antes de processar', 'error'); 
        return; 
    }
    
    cardProcessBtn.disabled = true;
    cardLoading.classList.remove('hidden');

    const form = new FormData();
    form.append('file', cardFile);

    try {
        const res = await fetch('/upload', { method: 'POST', body: form });
        if (!res.ok) {
            const txt = await res.text();
            throw new Error(`Erro servidor ${res.status}: ${txt}`);
        }
        const data = await res.json();
        handleOCRResult(data);
    } catch (err) {
        console.error('Erro processando OCR', err);
        showAlert('Erro ao processar imagem: ' + err.message, 'error');
    } finally {
        cardLoading.classList.add('hidden');
        cardProcessBtn.disabled = false;
    }
}

cardProcessBtn.addEventListener('click', processCardImage);

/* Fill fields from result */
function handleOCRResult(result) {
    // Apenas extrair dados do OCR, sem mostrar imagem processada
    const ocr = result.ocr_results || {};
    const db = result.database_results || {};

    const letters_raw = (ocr.letters_raw || '').toUpperCase();
    const numbers_raw = (ocr.numbers_raw || '') || (ocr.normalized_num || '');

    // preferred: data from database_match if exists
    if (db.database_match) {
        const card = db.database_match;
        // map fields (adjust names if your db uses different keys)
        document.getElementById('card-title').value = card.title || '';
        document.getElementById('card-season').value = card.season || '';
        document.getElementById('card-type').value = card.pokemon_type || '';
        // collection: try abbreviation or name
        document.getElementById('card-collection').value = card.collection_abbreviation || card.collection_name || '';
        // code: DB code probably exact
        document.getElementById('card-code').value = card.code || db.normalized_db_code || formatDbCode(letters_raw, numbers_raw) || '';
        document.getElementById('card-rarity').value = card.rarity || '';
        document.getElementById('card-nationality').value = card.nationality || '';
        showAlert('Carta encontrada no banco — campos preenchidos com dados do RTR', 'success');
    } else {
        // not found in DB: try to fill from OCR
        const guessCode = db.normalized_db_code || formatDbCode(letters_raw, numbers_raw);
        document.getElementById('card-code').value = guessCode || '';
        // set other fields empty or from OCR aggregate if available
        // attempt to set set letters as collection
        document.getElementById('card-collection').value = letters_raw || '';
        showAlert('Carta não encontrada no banco. Campos preenchidos com OCR (ajuste manual se necessário).', 'error');
    }
}

/* small alert helper */
function showAlert(msg, type='success', timeout=5000) {
    const alerts = document.getElementById('alerts');
    const div = document.createElement('div');
    div.className = 'alert ' + (type==='success' ? 'alert-success' : 'alert-error');
    div.textContent = msg;
    alerts.appendChild(div);
    setTimeout(()=> {
        div.style.opacity = '0';
        setTimeout(()=> div.remove(), 400);
    }, timeout);
}

/* Submit form: send to backend to create product (example) */
document.getElementById('product-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const payload = {
        name: document.getElementById('product-name').value,
        description: document.getElementById('product-description').value,
        type: document.getElementById('product-type').value,
        condition: document.getElementById('product-condition').value,
        price: parseFloat(document.getElementById('product-price').value || 0.0),
        store_id: document.getElementById('target-store-select').value,
        // card-specific:
        title: document.getElementById('card-title').value,
        season: document.getElementById('card-season').value,
        pokemon_type: document.getElementById('card-type').value,
        collection_id: document.getElementById('card-collection').value,
        code: document.getElementById('card-code').value,
        rarity: document.getElementById('card-rarity').value,
        nationality: document.getElementById('card-nationality').value,
    };

    try {
        // Ajuste a URL /payload conforme sua API de cadastro.
        const res = await fetch('/create_product', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        });
        const data = await res.json();
        if (res.ok && data.success) {
            showAlert('Produto cadastrado com sucesso!', 'success');
            // opcional: limpar form ou redirecionar
            setTimeout(() => {
                window.location.href = 'estoque.html';
            }, 1500);
        } else {
            throw new Error(data.message || 'Erro ao cadastrar produto');
        }
    } catch (err) {
        console.error(err);
        showAlert('Erro ao cadastrar produto: ' + err.message, 'error');
    }
});
</script>

</body>
</html>